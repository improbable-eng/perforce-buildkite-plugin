#!/bin/bash
set -eo pipefail

plugin_root="${BASH_SOURCE%/*}/.."

source ${plugin_root}/common

python_bin=$(get_python_bin)

# Ensure some version of virtualenv is installed
# Lazy install avoids races between different jobs wanting different versions
if [[ ! $(${python_bin} -m pip freeze) =~ "virtualenv==" ]]; then
    ${python_bin} -m pip install "virtualenv==16.7.7"
fi

# Unique virtualenv for requirements.txt
venv_dir=$(get_venv_dir)

venv_python_bin=$(get_venv_python_bin)

if ! [[ -d "${venv_dir}" ]]; then
    temp_venv_dir=$(mktemp -d -t perforce-plugin-venv-XXXXXX)
    trap "rm -rf ${temp_venv_dir}" EXIT
    ${python_bin} -m virtualenv "${temp_venv_dir}"
    ${temp_venv_dir}${venv_python_bin} -m pip install -r "${plugin_root}/python/requirements.txt"
    if ! [[ -d "${venv_dir}" ]]; then # second check to minimize venv init race
        mv "${temp_venv_dir}" "${venv_dir}"
    fi
    echo "virtualenv created at ${venv_dir}"
fi

python_path=$(get_python_path)
${python_path} "${plugin_root}/python/checkout.py"
